<div class="col-sm-12 col-xs-12">
  <h2>JSON Document: <%= @record.id %></h2>
  
  You can directly edit the JSON document below.
  
  <br><br>

  <div>
    <%= raw json_as_html(@record.json) %>
  </div>
  
  <%= render 'form' %>
</div>

<script>

  $(document).on('ready page:load', function() {
    // hide the text area
    $('#record_json_form_group').css('display', 'none');
    
    // intercept the save button click
    $('#save_button').on('click', function() {
      // set the textarea to the proper value
      setFormJson();
      // submit the form
      $('#json_form')[0].submit();
      // override default button behavior
      return false;
    });
    
    // hide all inputs initially
    $('.json-input').hide();
    
    // set behavior of json inputs
    setJsonInputListeners();

    // clicks outside of the table
    $(document).on('click', function() {
      revertJsonInputs();
    });

  });

  // sets the value for the json in the form
  function setFormJson() {
    // opening json string
    var json_string = '{';
    
    // for each json input
    $('.json-input').each(function() {
      // add the quoted string
      json_string += '"' + $(this).val().replace(/"/g, '\\"') + '"';
      // add a colon if this is a json key
      if ($(this).hasClass('json-key')) { json_string += ': '; }
      // else add a comma
      else { json_string += ', '; }
    });
    
    // remove the last 2 character: comma space
    if (json_string.length > 2) {
      json_string = json_string.slice(0, -2);
    }
    
    // closing json string
    json_string += '}';

    // replace line endings
    json_string = json_string.replace(/\n/g, '\\n');

    // set the form element
    $('#record_json').val(json_string);
  }

  // set behavior of json inputs
  function setJsonInputListeners() {
    // when a cell is clicked
    $('.json-hash').on('click', function() {
      // set the input
      setJsonInput($(this).find('.json-text'));
      // prevent the document click from firing and reverting the inputs
      event.stopPropagation();
    });
  }

  // hides json inputs and shows the text
  function revertJsonInputs() {
    $('.json-input').hide();
    $('.json-text').show();
  }

  // sets an input
  function setJsonInput($element) {
    // revert json inputs back to text
    revertJsonInputs();
    
    // hide the text
    $element.hide();
    // show the input
    $element.siblings('.json-input').show();
  }

</script>
